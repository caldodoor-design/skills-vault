---
name: fixing-tests
description: テストを実行し、スマートなエラーグルーピングで全ての失敗テストを体系的に修正する。テスト失敗の修正を依頼された場合に使用。
trigger: テスト修正の依頼、テスト失敗の報告、CI/CD失敗時
---

# テスト修正の体系的アプローチ

スマートなグルーピング戦略を用いて、全ての失敗テストを体系的に特定・修正する。

## 使用タイミング

- テスト修正を明示的に依頼された場合
- テスト失敗が報告された場合
- 実装完了後にテストを通したい場合
- CI/CDがテスト起因で失敗した場合

## 体系的アプローチ

### 1. 初回テスト実行

make test を実行して全ての失敗テストを特定する。

出力から以下を分析:
- 失敗の総数
- エラーの種類とパターン
- 影響を受けるモジュール/ファイル

### 2. スマートエラーグルーピング

類似の失敗をグループ化:
- **エラー種別**: ImportError, AttributeError, AssertionError 等
- **モジュール/ファイル別**: 同一ファイルが複数テスト失敗の原因
- **根本原因別**: 依存関係の欠落、API変更、リファクタリングの影響

優先順位の決定:
- 影響テスト数が多いものを優先（最大インパクト優先）
- 依存関係の順序に従う（インフラを先に、機能は後で）

### 3. 体系的修正プロセス

各グループについて（最大インパクトから順に）:

1. **根本原因の特定**
   - 関連コードを読む
   - git diff で最近の変更を確認
   - エラーパターンを理解

2. **修正の実装**
   - Edit ツールでコード変更
   - プロジェクト規約に従う
   - 最小限の変更に留める

3. **修正の検証**
   - グループ内のテストサブセットを実行
   - グループが通過するまで次に進まない

4. **次のグループへ移行**

### 4. 修正順序の戦略

**インフラ優先:**
- Import エラー
- 依存関係の欠落
- 設定の問題

**次にAPI変更:**
- 関数シグネチャの変更
- モジュール再編成
- 変数名/関数名の変更

**最後にロジックの問題:**
- アサーション失敗
- ビジネスロジックのバグ
- エッジケースの処理

### 5. 最終検証

全グループ修正後:
- 完全なテストスイートを実行
- リグレッションがないことを確認
- テストカバレッジが維持されていることを確認

## ベストプラクティス

- 一度に1グループずつ修正
- 各修正後に対象テストを実行
- git diff で最近の変更を把握
- 失敗のパターンを探す
- 現在のグループが通過するまで次に進まない
- 変更は最小限に留める

## ワークフロー例

1. make test 実行 → 15件の失敗を特定
2. エラーをグループ化:
   - 8件の ImportError（モジュール名変更）
   - 5件の AttributeError（関数シグネチャ変更）
   - 2件の AssertionError（ロジックバグ）
3. ImportError を先に修正 → サブセット実行 → 検証
4. AttributeError を修正 → サブセット実行 → 検証
5. AssertionError を修正 → サブセット実行 → 検証
6. 全テストスイート実行 → 全通過

## 元リポジトリ

https://github.com/mhattingpete/engineering-workflow-plugin